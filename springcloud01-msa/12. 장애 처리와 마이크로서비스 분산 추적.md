# CircuitBreaker

- 장애가 발생하는 서비스에 반복적인 호출이 되지 못하게 차단
- 특정 서비스가 정상적으로 동작하지 않을 경우 다른 기능으로 대체 수행 -> 장애 회피

### Hystrix 적용 방법

1. spring-cloud-starter-netflix-hystrix dependency 추가
2. @EnableCircuitBreaker 추가
3. feign.hystrix.enabled: true

### Resilience4j 적용 방법

- Hystrix 서비스 종료됨으로서 대체되는 라이브러리

1. spring-cloud-starter-circuitbreaker-resilience4j dependency 추가
2. Resilience4J 커스텀 Config 작성

```java
@Configuration
public class Resilience4JConfig {
    @Bean
    public Customizer<Resilience4JCircuitBreakerFactory> globalCustomConfiguration(){
        CircuitBreakerConfig circuitBreakerConfig = CircuitBreakerConfig.custom()
                .failureRateThreshold(4)
                .waitDurationInOpenState(Duration.ofMillis(1000))
                .slidingWindowType(CircuitBreakerConfig.SlidingWindowType.COUNT_BASED)
                .slidingWindowSize(2)
                .build();

        TimeLimiterConfig timeLimiterConfig = TimeLimiterConfig.custom()
                .timeoutDuration(Duration.ofSeconds(4))
                .build();

        return factory -> factory.configureDefault(id -> new Resilience4JConfigBuilder(id)
                .timeLimiterConfig(timeLimiterConfig)
                .circuitBreakerConfig(circuitBreakerConfig)
                .build());
    }
}

```

3. CircuitBreakerFactory 주입

```java
CircuitBreakerFactory circuitBreakerFactory;

@Autowired
public UserServiceImpl(UserRepository userRepository, BCryptPasswordEncoder passwordEncoder, Environment env,
                        RestTemplate restTemplate, OrderServiceClient orderServiceClient, CircuitBreakerFactory circuitBreakerFactory){
    this.userRepository = userRepository;
    this.passwordEncoder = passwordEncoder;
    this.env = env;
    this.restTemplate = restTemplate;
    this.orderServiceClient = orderServiceClient;
    this.circuitBreakerFactory = circuitBreakerFactory;
}
```

4. 에러날 경우 작업할 내용 추가

```java
 /* CircuitBreaker */
CircuitBreaker circuitBreaker = circuitBreakerFactory.create("circuitbreaker");
List<ResponseOrder> ordersList = circuitBreaker.run(() -> orderServiceClient.getOrders(userId), // 메서드를 실행시키는데,
        throwable -> new ArrayList<>() // 오류가 날 경우 빈 리스트 return
);
```

5. 결과

```json
{
  "email": "test1@test.com",
  "name": "ASH01",
  "userId": "dd9ce3d2-13af-4393-9b05-fbca838580c6",
  "orders": []
}
```

- 로그에는 에러가 나지만, orders가 빈칸으로 리턴된다.
